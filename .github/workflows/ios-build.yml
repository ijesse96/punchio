name: iOS Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        
    - name: Install dependencies
      run: flutter pub get
      
    - name: Setup iOS build environment
      run: |
        # Install CocoaPods
        sudo gem install cocoapods
        
        # Run iOS build fix script
        chmod +x ios_build_fix.sh
        ./ios_build_fix.sh
        
    - name: Verify iOS configuration
      run: |
        # Copy provisioning profile to iOS directory if it exists
        if [ -f "punchio.mobileprovision" ]; then
          cp punchio.mobileprovision ios/
          echo "Provisioning profile copied to iOS directory"
        fi
        
        # Verify Xcode project configuration
        echo "Checking Xcode project configuration..."
        grep -n "CODE_SIGN_STYLE" ios/Runner.xcodeproj/project.pbxproj || echo "CODE_SIGN_STYLE not found"
        grep -n "DEVELOPMENT_TEAM" ios/Runner.xcodeproj/project.pbxproj || echo "DEVELOPMENT_TEAM not found"
        grep -n "PRODUCT_BUNDLE_IDENTIFIER" ios/Runner.xcodeproj/project.pbxproj || echo "PRODUCT_BUNDLE_IDENTIFIER not found"
        
    - name: Build iOS app
      run: |
        # Set environment variables for build
        export FLUTTER_BUILD_MODE=release
        
        echo "üîç Debug: Starting iOS build with Apple Developer account..."
        echo "üìã Current configuration:"
        echo "   - Team ID: ${{ secrets.TEAM_ID }}"
        echo "   - Bundle ID: com.punchio.punchio"
        echo "   - Build mode: release"
        echo "   - Apple ID: ${{ secrets.APPLE_ID }}"
        
        # Build iOS app with proper code signing using Apple Developer account
        echo "üöÄ Running: flutter build ipa --release --export-options-plist=ios/ExportOptions.plist --verbose"
        flutter build ipa \
          --release \
          --export-options-plist=ios/ExportOptions.plist \
          --verbose || {
            echo "‚ùå Flutter build failed with exit code $?"
            echo "üîç Checking build directory contents..."
            ls -la build/ || echo "No build directory found"
            ls -la ios/build/ || echo "No ios/build directory found"
            echo "üîç Checking Flutter doctor..."
            flutter doctor -v
            exit 1
          }
          
    - name: Alternative build with xcodebuild (if Flutter build fails)
      if: failure()
      run: |
        echo "‚ùå Flutter build failed, trying direct xcodebuild..."
        cd ios
        
        echo "üîç Debug: Checking iOS project structure..."
        ls -la
        echo "üîç Checking Xcode project configuration..."
        grep -n "DEVELOPMENT_TEAM" Runner.xcodeproj/project.pbxproj
        grep -n "PRODUCT_BUNDLE_IDENTIFIER" Runner.xcodeproj/project.pbxproj
        
        # Clean build directory
        rm -rf build/
        
        echo "üöÄ Running xcodebuild with Apple Developer account..."
        # Build with xcodebuild using Apple Developer account credentials
        xcodebuild -workspace Runner.xcworkspace \
          -scheme Runner \
          -configuration Release \
          -destination generic/platform=iOS \
          -allowProvisioningUpdates \
          -allowProvisioningDeviceRegistration \
          CODE_SIGN_STYLE=Automatic \
          DEVELOPMENT_TEAM=${{ secrets.TEAM_ID }} \
          PRODUCT_BUNDLE_IDENTIFIER=com.punchio.punchio \
          archive \
          -archivePath Runner.xcarchive \
          -verbose || {
            echo "‚ùå xcodebuild archive failed with exit code $?"
            echo "üîç Checking for common issues..."
            echo "üìã Xcode version:"
            xcodebuild -version
            echo "üìã Available simulators:"
            xcrun simctl list devices
            exit 1
          }
          
        echo "‚úÖ Archive created successfully, exporting IPA..."
        # Export IPA from archive
        xcodebuild -exportArchive \
          -archivePath Runner.xcarchive \
          -exportPath ./build \
          -exportOptionsPlist ExportOptions.plist \
          -allowProvisioningUpdates \
          -verbose || {
            echo "‚ùå Export failed with exit code $?"
            echo "üîç Checking archive contents..."
            ls -la Runner.xcarchive/
            exit 1
          }
          
        echo "‚úÖ IPA export completed successfully!"
        echo "üîç Checking build output..."
        ls -la build/
        find build/ -name "*.ipa" -type f
          
        cd ..
        
    - name: Upload build artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ios-build-artifacts
        path: |
          build/ios/ipa/*.ipa
          ios/build/*.ipa
        retention-days: 7
        
    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: ios-build-logs
        path: |
          build/
          ios/build/
        retention-days: 3