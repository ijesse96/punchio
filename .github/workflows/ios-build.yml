name: iOS Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        
    - name: Install dependencies
      run: flutter pub get
      
    - name: Setup iOS build environment
      run: |
        # Install CocoaPods
        sudo gem install cocoapods
        
        # Navigate to iOS directory and install pods
        cd ios
        pod install
        cd ..
        
    - name: Configure iOS signing
      run: |
        # Copy provisioning profile to iOS directory if it exists
        if [ -f "punchio.mobileprovision" ]; then
          cp punchio.mobileprovision ios/
          echo "Provisioning profile copied to iOS directory"
        fi
        
        # Verify Xcode project configuration
        echo "Checking Xcode project configuration..."
        grep -n "CODE_SIGN_STYLE" ios/Runner.xcodeproj/project.pbxproj
        grep -n "DEVELOPMENT_TEAM" ios/Runner.xcodeproj/project.pbxproj
        grep -n "PRODUCT_BUNDLE_IDENTIFIER" ios/Runner.xcodeproj/project.pbxproj
        
    - name: Build iOS app
      run: |
        # Build with Flutter
        flutter build ipa \
          --release \
          --export-options-plist=ios/ExportOptions.plist \
          --verbose
          
    - name: Alternative build with xcodebuild (if Flutter build fails)
      if: failure()
      run: |
        echo "Flutter build failed, trying direct xcodebuild..."
        cd ios
        
        # Build with xcodebuild and automatic provisioning
        xcodebuild -workspace Runner.xcworkspace \
          -scheme Runner \
          -configuration Release \
          -destination generic/platform=iOS \
          -allowProvisioningUpdates \
          -allowProvisioningDeviceRegistration \
          archive \
          -archivePath Runner.xcarchive \
          -verbose
          
        # Export IPA from archive
        xcodebuild -exportArchive \
          -archivePath Runner.xcarchive \
          -exportPath ./build \
          -exportOptionsPlist ExportOptions.plist \
          -allowProvisioningUpdates
          
        cd ..
        
    - name: Upload build artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ios-build-artifacts
        path: |
          build/ios/ipa/*.ipa
          ios/build/*.ipa
        retention-days: 7
        
    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: ios-build-logs
        path: |
          build/
          ios/build/
        retention-days: 3