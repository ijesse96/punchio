name: iOS Clean Build

on:
  workflow_dispatch:  # Manual trigger
  push:
    branches: [ main ]

jobs:
  build-ios:
    runs-on: macos-14
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        
    - name: Install dependencies
      run: flutter pub get
      
    - name: Setup iOS build environment
      run: |
        # Install CocoaPods
        sudo gem install cocoapods --quiet
        
        # Navigate to iOS directory and install pods
        cd ios
        pod install
        cd ..
        
    - name: Verify GitHub Secrets
      run: |
        echo "ğŸ” Verifying GitHub secrets..."
        echo "IOS_CERT_P12_BASE64 secret exists: ${{ secrets.IOS_CERT_P12_BASE64 != '' }}"
        echo "IOS_PROFILE_BASE64 secret exists: ${{ secrets.IOS_PROFILE_BASE64 != '' }}"
        echo "IOS_CERT_PASSWORD secret exists: ${{ secrets.IOS_CERT_PASSWORD != '' }}"
        echo "IOS_TEAM_ID secret exists: ${{ secrets.IOS_TEAM_ID != '' }}"
        echo "IOS_BUNDLE_ID secret exists: ${{ secrets.IOS_BUNDLE_ID != '' }}"
        echo "APPLE_ID secret exists: ${{ secrets.APPLE_ID != '' }}"
        echo "APPLE_PASSWORD secret exists: ${{ secrets.APPLE_PASSWORD != '' }}"
        
        if [ -z "${{ secrets.IOS_CERT_P12_BASE64 }}" ]; then
          echo "âŒ ERROR: IOS_CERT_P12_BASE64 secret is not set!"
          exit 1
        fi
        if [ -z "${{ secrets.IOS_PROFILE_BASE64 }}" ]; then
          echo "âŒ ERROR: IOS_PROFILE_BASE64 secret is not set!"
          exit 1
        fi
        if [ -z "${{ secrets.IOS_CERT_PASSWORD }}" ]; then
          echo "âŒ ERROR: IOS_CERT_PASSWORD secret is not set!"
          exit 1
        fi
        if [ -z "${{ secrets.IOS_TEAM_ID }}" ]; then
          echo "âŒ ERROR: IOS_TEAM_ID secret is not set!"
          exit 1
        fi
        if [ -z "${{ secrets.IOS_BUNDLE_ID }}" ]; then
          echo "âŒ ERROR: IOS_BUNDLE_ID secret is not set!"
          exit 1
        fi
        
        echo "âœ… All required secrets are available"
        
    - name: Decode signing files
      shell: bash
      run: |
        echo "$IOS_CERT_P12_BASE64" | base64 --decode > cert.p12
        echo "$IOS_PROFILE_BASE64"   | base64 --decode > Punchio.mobileprovision
      env:
        IOS_CERT_P12_BASE64: ${{ secrets.IOS_CERT_P12_BASE64 }}
        IOS_PROFILE_BASE64:  ${{ secrets.IOS_PROFILE_BASE64 }}

    - name: Extract key and cert from P12
      shell: bash
      run: |
        # Convert p12 to a flat PEM (contains both cert and private key)
        openssl pkcs12 -in cert.p12 -passin pass:"$IOS_CERT_PASSWORD" -nodes -out signing.pem

        # Split PEM into separate files
        awk 'BEGIN{p=0}/-----BEGIN PRIVATE KEY-----/{p=1} p; /-----END PRIVATE KEY-----/{print; exit}' signing.pem > signing.key
        awk 'BEGIN{p=0}/-----BEGIN CERTIFICATE-----/{p=1} p; /-----END CERTIFICATE-----/{print; exit}' signing.pem > signing.cer

        # Quick sanity check
        test -s signing.key && test -s signing.cer || { echo "Missing key/cert after extraction"; exit 1; }
      env:
        IOS_CERT_PASSWORD: ${{ secrets.IOS_CERT_PASSWORD }}

    - name: Import key+cert into temp keychain (robust)
      shell: bash
      run: |
        set -eo pipefail

        KEYCHAIN_NAME=build.keychain
        KEYCHAIN_PATH="$HOME/Library/Keychains/${KEYCHAIN_NAME}-db"

        # Create & unlock keychain
        security create-keychain -p "" "$KEYCHAIN_NAME"
        security set-keychain-settings -lut 21600 "$KEYCHAIN_NAME"
        security unlock-keychain -p "" "$KEYCHAIN_NAME"

        # Sanity check files from previous step
        echo "ğŸ“¦ Files present:" && ls -l signing.* || true

        # Convert the private key to PKCS#1 ("openssl" format) â€” most reliable for `security import`
        openssl rsa -in signing.key -out signing_rsa.key

        # Import certificate (PEM sequence) and private key (OpenSSL/PKCS#1) into our keychain
        security import signing.cer     -k "$KEYCHAIN_PATH" -A -t cert -f pemseq -T /usr/bin/codesign -T /usr/bin/security
        security import signing_rsa.key -k "$KEYCHAIN_PATH" -A -t priv -f openssl -T /usr/bin/codesign -T /usr/bin/security

        # Make this keychain active for the build
        security list-keychains -s "$KEYCHAIN_PATH" "$HOME/Library/Keychains/login.keychain-db"
        security default-keychain -s "$KEYCHAIN_PATH"
        security unlock-keychain -p "" "$KEYCHAIN_NAME"

        # Allow non-interactive codesign access
        security set-key-partition-list -S apple-tool:,apple: -s -k "" "$KEYCHAIN_PATH"

        echo "ğŸ”‘ Identities now available:"
        security find-identity -v -p codesigning || true

    - name: Install provisioning profile
      shell: bash
      run: |
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp Punchio.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/punchio.mobileprovision

    - name: Inspect signing setup
      shell: bash
      run: |
        echo "ğŸ”‘ Identities:"
        security find-identity -v -p codesigning || true

        echo "ğŸ“„ Profile app id:"
        security cms -D -i ~/Library/MobileDevice/Provisioning\ Profiles/punchio.mobileprovision -o profile.plist
        /usr/libexec/PlistBuddy -c 'Print :Entitlements:application-identifier' profile.plist || true

    - name: Verify signing material
      run: |
        echo "ğŸ” Verifying imported signing material..."
        
        # Check if certificate was imported
        echo "ğŸ“‹ Available certificates:"
        security find-identity -v -p codesigning
        
        # Check if provisioning profile was installed
        echo "ğŸ“‹ Installed provisioning profiles:"
        ls -la ~/Library/MobileDevice/Provisioning\ Profiles/
        
        # Verify the specific profile
        if [ -f ~/Library/MobileDevice/Provisioning\ Profiles/punchio.mobileprovision ]; then
          echo "âœ… Provisioning profile installed successfully"
          # Show profile details
          security cms -D -i ~/Library/MobileDevice/Provisioning\ Profiles/punchio.mobileprovision | \
            grep -A 5 -B 5 "com.punchio.punchio" || echo "âš ï¸  Bundle ID not found in profile"
        else
          echo "âŒ Provisioning profile not found!"
          exit 1
        fi
        
        echo "âœ… Signing material verification completed"
        
    - name: Debug iOS Project
      run: |
        echo "ğŸ” Debugging iOS project configuration..."
        echo "ğŸ“‹ iOS project structure:"
        ls -la ios/
        echo ""
        echo "ğŸ“‹ Xcode project settings:"
        grep -n "DEVELOPMENT_TEAM\|PRODUCT_BUNDLE_IDENTIFIER\|CODE_SIGN_STYLE" ios/Runner.xcodeproj/project.pbxproj | head -10
        echo ""
        echo "ğŸ“‹ Export options:"
        cat ios/ExportOptions.plist
        echo ""
        echo "ğŸ“‹ Podfile:"
        head -20 ios/Podfile
        
    - name: Install ruby helper for Xcodeproj
      run: gem install xcodeproj -N

    - name: Write Team/Bundle into Runner.xcodeproj
      shell: bash
      env:
        IOS_TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
        IOS_BUNDLE_ID: ${{ secrets.IOS_BUNDLE_ID }}
      run: |
        set -euo pipefail
        cat > set_team.rb <<'RUBY'
        require 'xcodeproj'
        project_path = 'ios/Runner.xcodeproj'
        team   = ENV['IOS_TEAM_ID']
        bundle = ENV['IOS_BUNDLE_ID']

        proj = Xcodeproj::Project.open(project_path)

        # Find the Runner target
        runner = proj.targets.find { |t| t.name == 'Runner' }
        raise "Runner target not found" unless runner

        # Ensure Team & Bundle are set on Runner target build settings (Debug/Release)
        runner.build_configurations.each do |cfg|
          cfg.build_settings['DEVELOPMENT_TEAM'] = team
          cfg.build_settings['PRODUCT_BUNDLE_IDENTIFIER'] = bundle
          cfg.build_settings['CODE_SIGN_STYLE'] = 'Automatic'
          cfg.build_settings.delete('PROVISIONING_PROFILE_SPECIFIER')
          cfg.build_settings.delete('CODE_SIGN_IDENTITY')
        end

        # Also set Team at the project level (helps Xcode embed Team in archive metadata)
        proj.build_configurations.each do |cfg|
          cfg.build_settings['DEVELOPMENT_TEAM'] = team
        end

        # TargetAttributes â†’ DevelopmentTeam (this is what Xcode's Signing UI writes)
        proj.root_object.attributes['TargetAttributes'] ||= {}
        attrs = proj.root_object.attributes['TargetAttributes']
        attrs[runner.uuid] ||= {}
        attrs[runner.uuid]['DevelopmentTeam'] = team

        proj.save
        RUBY
        ruby set_team.rb

        echo "âœ… Team & bundle written into ios/Runner.xcodeproj"

    - name: Archive with xcodebuild (Team now in project)
      shell: bash
      run: |
        set -euo pipefail
        ARCHIVE_PATH="build/ios/archive/Runner.xcarchive"
        KEYCHAIN_PATH="$HOME/Library/Keychains/build.keychain-db"

        xcodebuild \
          -workspace ios/Runner.xcworkspace \
          -scheme Runner \
          -configuration Release \
          -destination "generic/platform=iOS" \
          -archivePath "$ARCHIVE_PATH" \
          clean archive \
          OTHER_CODE_SIGN_FLAGS="--keychain $KEYCHAIN_PATH"

        echo "ğŸ” Team in archive now?"
        /usr/libexec/PlistBuddy -c 'Print :ApplicationProperties:Team' "$ARCHIVE_PATH/Info.plist"

    - name: Export IPA
      shell: bash
      run: |
        set -euo pipefail
        EXPORT_DIR="build/ios/ipa"; mkdir -p "$EXPORT_DIR"
        xcodebuild -exportArchive \
          -archivePath build/ios/archive/Runner.xcarchive \
          -exportPath "$EXPORT_DIR" \
          -exportOptionsPlist ios/ExportOptions.plist
        ls -lah "$EXPORT_DIR"
        
    - name: Upload IPA file
      uses: actions/upload-artifact@v4
      with:
        name: punchio-ipa
        path: |
          build/**/*.ipa
        retention-days: 30
        
    - name: Debug on failure
      if: failure()
      run: |
        echo "ğŸ” Debug information:"
        echo "ğŸ“‹ Flutter doctor:"
        flutter doctor -v
        echo ""
        echo "ğŸ“‹ iOS project structure:"
        ls -la ios/
        echo ""
        echo "ğŸ“‹ Xcode project settings:"
        grep -n "DEVELOPMENT_TEAM\|PRODUCT_BUNDLE_IDENTIFIER\|CODE_SIGN_STYLE" ios/Runner.xcodeproj/project.pbxproj | head -10
        echo ""
        echo "ğŸ“‹ Export options:"
        cat ios/ExportOptions.plist
        echo ""
        echo "ğŸ“‹ GitHub Secrets Status:"
        echo "IOS_CERT_P12_BASE64 secret exists: ${{ secrets.IOS_CERT_P12_BASE64 != '' }}"
        echo "IOS_PROFILE_BASE64 secret exists: ${{ secrets.IOS_PROFILE_BASE64 != '' }}"
        echo "IOS_CERT_PASSWORD secret exists: ${{ secrets.IOS_CERT_PASSWORD != '' }}"
        echo "IOS_TEAM_ID secret exists: ${{ secrets.IOS_TEAM_ID != '' }}"
        echo "IOS_BUNDLE_ID secret exists: ${{ secrets.IOS_BUNDLE_ID != '' }}"
        echo "APPLE_ID secret exists: ${{ secrets.APPLE_ID != '' }}"
        echo "APPLE_PASSWORD secret exists: ${{ secrets.APPLE_PASSWORD != '' }}"
        echo "APP_DISPLAY_NAME secret exists: ${{ secrets.APP_DISPLAY_NAME != '' }}"
